{{- $src := or .src .url -}}
{{ $img := .img }}
{{ $absoluteURL := or .absoluteUrl .absoluteURL }}
{{ $dims := .dims }}
{{- $ratio := .ratio -}}
{{ $hook := .hook }}
{{ $transform := .transform }}
{{ $format := .format }}
{{ $includeWidth := .includeWidth | default true }}
{{ $anchor := .anchor | default "" }}

{{ $host := (urls.Parse $src).Hostname }}
{{ $dir := (urls.Parse $src).Path }}
{{ $file := index ((split $dir "/") | collections.Reverse) 0 }}
{{ $dir = strings.TrimSuffix $file $dir }}

{{ $adapter := (printf "assets/adapters/%s.html" $hook) }}
{{ if not (fileExists (path.Join "/layouts/_partials" $adapter)) }}
    {{ warnf "Cannot find adapter: %s" (path.Join "/layouts/_partials" $adapter) }}
    {{ $hook = "hugo" }}
    {{ $adapter = "assets/adapters/hugo.html" }}
{{ end }}

{{ $imgset := slice }}
{{- range $index, $dim := $dims -}}
    {{ $width := (int (index (split $dim "x") 0)) }}
    {{ $height := (int (index (split $dim "x") 1)) }}

    {{- $element := partial $adapter (dict 
        "url-host"     $host
        "url-dir"      $dir
        "url-file"     $file
        "img"          $img
        "absolute-url" $absoluteURL
        "transform"    $transform
        "image-width"  $width
        "image-height" $height
        "format"       $format
        "anchor"       $anchor
    )}}
    {{ if $includeWidth }}
        {{ $imgset = $imgset | append (printf "%s %dw" $element $width) }}
    {{ else }}
        {{ $imgset = $imgset | append $element }}
    {{ end }}
{{- end -}}

{{ return (delimit $imgset ", ") }}